<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تسليم الواجب</title>
<style>
body{font-family:'Cairo',sans-serif;background:#f0f4f8;margin:0;padding:0;display:flex;justify-content:center;align-items:center;min-height:100vh;}
.container{width:95%; max-width:600px;}
.card{background:#fff;border-radius:15px;padding:20px;box-shadow:0 8px 20px rgba(0,0,0,0.1);margin-bottom:20px;animation:fadeIn 0.5s;}
h2{text-align:center;color:#0369a1;}
input{width:100%;padding:10px;margin:10px 0;border-radius:10px;border:1px solid #ccc;}
button{width:100%;padding:12px;margin:10px 0;background:#0ea5a3;color:#fff;border:none;border-radius:10px;font-size:16px;cursor:pointer;transition:0.3s;}
button:hover{background:#0369a1;}
label{display:block;margin:5px 0;}
@keyframes fadeIn{from{opacity:0} to{opacity:1}}
</style>
</head>
<body>
<div class="container">

<div class="card" id="startCard">
<h2>اختر نوع الطالب</h2>
<button onclick="selectType('onLine')">اونلاين</button>
<button onclick="selectType('center')">سنتر</button>
</div>

<div class="card" id="formCard" style="display:none;">
<h2>املأ بياناتك</h2>
<input type="text" id="studentName" placeholder="الاسم">
<input type="text" id="studentMobile" placeholder="رقم الموبايل">
<input type="text" id="centerCode" placeholder="كود السنتر" style="display:none;">
<button onclick="startHomework()">ابدأ الواجب</button>
</div>

<div class="card" id="homeworkCard" style="display:none;">
<h2>الواجب</h2>
<div id="questionsContainer" style="max-height:400px; overflow-y:auto;"></div>
<button onclick="submitHomework()">تسليم الواجب</button>
</div>

<div class="card" id="qrCard" style="display:none;">
<h2>تم تسليم الواجب بنجاح 🎉</h2>
<img id="qrImage" src="" style="display:block;margin:10px auto;width:250px;height:250px;">
<p id="qrNote" style="text-align:center;font-weight:bold;"></p>
</div>

</div>

<script>
let studentType = '';
let homeworkData = [];
const API_URL = "https://script.google.com/macros/s/AKfycby9mob6o99x0dewsSLc8lspXn1ph94cpW3iUI7NaasEEx_hvs2M0W7vgtw_3_oC8EOg/exec";

function selectType(type){
  studentType = type;
  document.getElementById('startCard').style.display = 'none';
  document.getElementById('formCard').style.display = 'block';
  if(type=='center'){
    document.getElementById('centerCode').style.display='block';
  }
}

function startHomework(){
  const name = document.getElementById('studentName').value;
  const mobile = document.getElementById('studentMobile').value;
  const code = document.getElementById('centerCode').value;
  if(name=="" || mobile=="") return alert("اكمل البيانات");

  const container = document.getElementById('questionsContainer');
  container.innerHTML = "<p style='text-align:center;'>⏳ جاري تحميل الواجب ...</p>";

  fetch(`${API_URL}?action=getHomework`)
  .then(res => res.json())
  .then(data=>{
    homeworkData = data;
    showHomework();
  }).catch(err=>{
    container.innerHTML = "";
    alert("❌ فشل تحميل الواجب");
    console.log(err);
  });
}

function showHomework(){
  document.getElementById('formCard').style.display='none';
  document.getElementById('homeworkCard').style.display='block';
  const container = document.getElementById('questionsContainer');
  container.innerHTML = "";
  homeworkData.forEach(q=>{
    let div = document.createElement('div');
    div.innerHTML = `<p>${q.number}. ${q.text}</p>`;
    q.options.forEach((opt,i)=>{
      div.innerHTML += `<label><input type="checkbox" name="q${q.number}" value="${i}"> ${opt}</label>`;
    });
    container.appendChild(div);
  });
}

function submitHomework(){
  const studentData = {
    name: document.getElementById('studentName').value,
    mobile: document.getElementById('studentMobile').value,
    type: studentType,
    code: document.getElementById('centerCode').value,
    homeworkName: "اسم الواجب"
  };

  fetch(`${API_URL}?action=getQR&data=`+encodeURIComponent(JSON.stringify(studentData)))
  .then(res=>res.json())
  .then(data=>{
    document.getElementById('homeworkCard').style.display='none';
    document.getElementById('qrCard').style.display='block';
    document.getElementById('qrImage').src = data.qr;
    document.getElementById('qrNote').innerText = studentType=="center" ? "نزل QR على موبايلك للدخول" : "ابعت الواجب على الرقم عبر واتس اب";
  }).catch(err=>{
    alert("❌ فشل توليد QR");
    console.log(err);
  });
}
</script>

</body>
</html>
