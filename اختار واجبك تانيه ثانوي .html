<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª - Ù…Ø³ØªØ± ÙÙŠØµÙ„</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(145deg, #667eea15 0%, #764ba215 100%);
            min-height: 100vh;
            padding: 20px;
            color: #1e293b;
        }
        
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loader {
            text-align: center;
        }
        
        .spinner {
            width: 70px;
            height: 70px;
            border: 5px solid #f0f0f0;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }
        
        .loader p {
            font-size: 22px;
            color: #334155;
            font-weight: 600;
        }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px 20px;
            border-radius: 30px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .header h1 {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 18px;
            opacity: 0.95;
        }
        
        /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª */
        .homework-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .homework-card {
            background: white;
            border-radius: 25px;
            padding: 25px 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            text-align: center;
        }
        
        .homework-card:hover {
            transform: translateY(-8px);
            border-color: #667eea;
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.2);
        }
        
        .card-icon {
            width: 70px;
            height: 70px;
            background: #f0f4ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 30px;
            color: #667eea;
        }
        
        .homework-title {
            font-size: 22px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 10px;
        }
        
        .homework-desc {
            color: #64748b;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .badge {
            background: #f0f4ff;
            color: #667eea;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: inline-block;
        }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
        .form-card {
            background: white;
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #334155;
        }
        
        .form-group input {
            width: 100%;
            padding: 15px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            font-size: 16px;
            font-family: 'Cairo', sans-serif;
            transition: all 0.3s;
        }
        
        .form-group input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .privacy {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: #f8fafc;
            border-radius: 15px;
        }
        
        .privacy input {
            width: 20px;
            height: 20px;
        }
        
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 700;
            font-family: 'Cairo', sans-serif;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #334155;
            margin-top: 10px;
        }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© */
        .questions-container {
            background: white;
            border-radius: 30px;
            padding: 30px;
        }
        
        .progress {
            height: 8px;
            background: #e2e8f0;
            border-radius: 10px;
            margin: 15px 0 25px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.4s;
            width: 0%;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #64748b;
        }
        
        .question-card {
            display: none;
            margin: 20px 0;
        }
        
        .question-card.active {
            display: block;
            animation: slide 0.3s;
        }
        
        .question-text {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 25px;
        }
        
        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .option {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .option input {
            width: 20px;
            height: 20px;
        }
        
        .nav-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .nav-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .nav-btn.next {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .nav-btn.prev {
            background: #f1f5f9;
            color: #334155;
        }
        
        .completed-msg {
            text-align: center;
            padding: 30px;
            background: #e8f5e9;
            border-radius: 20px;
            margin: 20px 0;
            color: #2e7d32;
        }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© */
        .result-card {
            background: white;
            border-radius: 30px;
            padding: 30px;
            text-align: center;
        }
        
        .qr-container {
            background: #f8fafc;
            padding: 20px;
            border-radius: 20px;
            margin: 20px 0;
            display: flex;
            justify-content: center;
        }
        
        .student-details {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 20px;
            margin: 20px 0;
            text-align: right;
            line-height: 2;
        }
        
        .score-badge {
            display: inline-block;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 50px;
            font-size: 24px;
            font-weight: 700;
            margin: 15px 0;
        }
        
        .advice {
            font-size: 22px;
            font-weight: 700;
            color: #667eea;
            margin: 20px 0;
            padding: 20px;
            background: #f0f4ff;
            border-radius: 20px;
        }
        
        /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© */
        .review-table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 15px;
            text-align: right;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .review-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
            padding: 15px;
        }
        
        .review-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .review-table tr:last-child td {
            border-bottom: none;
        }
        
        .review-table tr:hover {
            background: #f8fafc;
        }
        
        .correct-answer {
            color: #10b981;
            font-weight: 700;
        }
        
        .wrong-answer {
            color: #ef4444;
            font-weight: 700;
        }
        
        .icon-correct {
            color: #10b981;
            font-size: 18px;
            margin-left: 5px;
        }
        
        .icon-wrong {
            color: #ef4444;
            font-size: 18px;
            margin-left: 5px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes slide {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 28px; }
            .homework-grid { grid-template-columns: 1fr; }
            .review-table { font-size: 13px; }
            .review-table th, .review-table td { padding: 8px; }
        }
    </style>
</head>
<body>

<div id="app">
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loader">
            <div class="spinner"></div>
            <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª...</p>
        </div>
    </div>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div id="mainContent" style="display: none;">
        <div class="container">
            <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
            <div class="header">
                <h1><i class="fas fa-tasks"></i> Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª</h1>
                <p>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ø¨Ø·Ù„ØŒ Ø§Ø®ØªØ± ÙˆØ§Ø¬Ø¨Ùƒ ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ø­Ù„</p>
            </div>

            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª -->
            <div id="homeworkListScreen">
                <div class="homework-grid" id="homeworkGrid"></div>
            </div>

            <!-- Ø´Ø§Ø´Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
            <div id="formScreen" style="display: none;">
                <div class="form-card">
                    <h2 style="text-align: center; margin-bottom: 25px;">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</h2>
                    
                    <div id="selectedHomeworkInfo" style="background: #f0f4ff; padding: 15px; border-radius: 15px; margin-bottom: 25px; text-align: center;">
                        <p id="selectedHomeworkTitle" style="font-weight: 700;"></p>
                    </div>

                    <div class="form-group">
                        <label>Ø§Ù„Ø§Ø³Ù… Ø«Ù„Ø§Ø«ÙŠ</label>
                        <input type="text" id="studentName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ">
                    </div>

                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
                        <input type="text" id="studentMobile" placeholder="Ù…Ø«Ø§Ù„: 01234567890">
                    </div>

                    <div class="form-group" id="centerCodeGroup" style="display: none;">
                        <label>ÙƒÙˆØ¯ Ø§Ù„Ø³Ù†ØªØ±</label>
                        <input type="text" id="centerCode" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø³Ù†ØªØ±">
                    </div>

                    <div class="privacy">
                        <input type="checkbox" id="privacyCheck">
                        <label>Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</label>
                    </div>

                    <button class="btn btn-primary" onclick="startHomework()">
                        <i class="fas fa-play"></i> Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙˆØ§Ø¬Ø¨
                    </button>
                    <button class="btn btn-secondary" onclick="backToList()">
                        <i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹
                    </button>
                </div>
            </div>

            <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
            <div id="questionsScreen" style="display: none;">
                <div class="questions-container">
                    <div class="question-header">
                        <span id="currentQuestion">Ø§Ù„Ø³Ø¤Ø§Ù„ 1</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
                    </div>

                    <div id="questionsContainer"></div>

                    <div id="completedMessage" style="display: none;" class="completed-msg">
                        <i class="fas fa-trophy" style="font-size: 40px;"></i>
                        <h3 style="margin: 15px 0;">Ù…Ø¨Ø±ÙˆÙƒ! Ø®Ù„ØµØª ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
                        <p>Ø¯Ù„ÙˆÙ‚ØªÙŠ ØªÙ‚Ø¯Ø± ØªØ³Ù„Ù… ÙˆØ§Ø¬Ø¨Ùƒ</p>
                    </div>

                    <div class="nav-buttons">
                        <button class="nav-btn prev" id="prevBtn" onclick="prevQuestion()">
                            <i class="fas fa-arrow-right"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚
                        </button>
                        <button class="nav-btn next" id="nextBtn" onclick="nextQuestion()">
                            Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-arrow-left"></i>
                        </button>
                    </div>

                    <div id="submitButtons" style="display: none; margin-top: 20px;">
                        <button class="btn btn-primary" id="submitBtn" onclick="submitHomework()">
                            <i class="fas fa-check-circle"></i> Ø³Ù„Ù… Ø§Ù„ÙˆØ§Ø¬Ø¨
                        </button>
                    </div>
                </div>
            </div>

            <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© -->
            <div id="resultScreen" style="display: none;">
                <div class="result-card">
                    <i class="fas fa-check-circle" style="font-size: 60px; color: #10b981;"></i>
                    <h2 style="margin: 15px 0;">ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­ Ø¨Ù†Ø¬Ø§Ø­!</h2>
                    
                    <div class="qr-container" id="qrContainer"></div>
                    
                    <div class="student-details" id="studentDetails"></div>
                    
                    <div class="score-badge" id="scoreDisplay"></div>
                    
                    <!-- Ø¬Ø¯ÙˆÙ„ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª -->
                    <div style="margin: 30px 0; text-align: right;">
                        <h3 style="margin-bottom: 15px; color: #334155;">
                            <i class="fas fa-clipboard-check" style="margin-left: 10px;"></i>
                            Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ:
                        </h3>
                        <div style="overflow-x: auto;">
                            <table class="review-table" id="reviewTable">
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ø³Ø¤Ø§Ù„</th>
                                        <th>Ø¥Ø¬Ø§Ø¨ØªÙƒ</th>
                                        <th>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</th>
                                        <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                                    </tr>
                                </thead>
                                <tbody id="reviewTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="advice" id="adviceText"></div>
                    
                    <button class="btn btn-primary" onclick="resetApp()">
                        <i class="fas fa-home"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/kjua@0.1.1/dist/kjua.min.js"></script>
<script>
    // Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    const APP_URL = "https://script.google.com/macros/s/AKfycbyOyO4nFtC4BpWvzzsuBJN4xEfKogfvpOsRxJ92uIkUEq_p9VBx5SSdTfy_KbbU6wXj/exec";
    
    // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    let homeworkList = [];
    let currentHomework = null;
    let homeworkQuestions = [];
    let studentType = 'online';
    let currentQuestionIndex = 0;
    let userAnswers = {};

    // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    window.onload = function() {
        loadHomeworkList();
    };

    // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª
    async function loadHomeworkList() {
        try {
            const response = await fetch(`${APP_URL}?action=getHomeworkList&_=${Date.now()}`);
            const data = await response.json();
            
            if (Array.isArray(data)) {
                homeworkList = data.filter(hw => hw && hw.id);
            } else {
                // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
                homeworkList = [
                    { id: 'DEMO_1', title: 'ÙˆØ§Ø¬Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ', description: 'Ù‡Ø°Ø§ ÙˆØ§Ø¬Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ', questionsCount: 3 }
                ];
            }
            
            displayHomeworkList();
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„:', error);
            // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
            homeworkList = [
                { id: 'DEMO_1', title: 'ÙˆØ§Ø¬Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ', description: 'Ù‡Ø°Ø§ ÙˆØ§Ø¬Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ', questionsCount: 3 }
            ];
            displayHomeworkList();
        }
    }

    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª
    function displayHomeworkList() {
        const grid = document.getElementById('homeworkGrid');
        
        if (!homeworkList || homeworkList.length === 0) {
            grid.innerHTML = `
                <div style="grid-column:1/-1; text-align:center; padding:40px; background:white; border-radius:20px;">
                    <i class="fas fa-folder-open" style="font-size:50px; color:#94a3b8;"></i>
                    <p style="margin-top:15px; color:#64748b;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ§Ø¬Ø¨Ø§Øª Ù…ØªØ§Ø­Ø©</p>
                </div>
            `;
        } else {
            grid.innerHTML = homeworkList.map(hw => `
                <div class="homework-card" onclick="selectHomework('${hw.id}')">
                    <div class="card-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <div class="homework-title">${hw.title || 'ÙˆØ§Ø¬Ø¨'}</div>
                    <div class="homework-desc">${hw.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</div>
                    <span class="badge"><i class="fas fa-question-circle"></i> ${hw.questionsCount || 0} Ø£Ø³Ø¦Ù„Ø©</span>
                </div>
            `).join('');
        }
        
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
    }

    // Ø§Ø®ØªÙŠØ§Ø± ÙˆØ§Ø¬Ø¨
    function selectHomework(homeworkId) {
        currentHomework = homeworkList.find(h => h.id === homeworkId);
        if (currentHomework) {
            document.getElementById('selectedHomeworkTitle').innerText = currentHomework.title || 'Ø§Ù„ÙˆØ§Ø¬Ø¨';
            document.getElementById('formScreen').style.display = 'block';
            document.getElementById('homeworkListScreen').style.display = 'none';
        }
    }

    // Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
    function backToList() {
        document.getElementById('formScreen').style.display = 'none';
        document.getElementById('homeworkListScreen').style.display = 'block';
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„ÙˆØ§Ø¬Ø¨
    async function startHomework() {
        const name = document.getElementById('studentName').value.trim();
        const mobile = document.getElementById('studentMobile').value.trim();
        const privacy = document.getElementById('privacyCheck').checked;

        if (!name || !mobile) {
            alert('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„');
            return;
        }
        if (!privacy) {
            alert('âŒ ÙŠØ¬Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©');
            return;
        }
        if (!currentHomework) {
            alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙˆØ§Ø¬Ø¨');
            backToList();
            return;
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        document.getElementById('loadingScreen').style.display = 'flex';
        document.getElementById('mainContent').style.display = 'none';

        try {
            const response = await fetch(`${APP_URL}?action=getHomework&id=${currentHomework.id}&_=${Date.now()}`);
            const data = await response.json();
            
            if (Array.isArray(data) && data.length > 0) {
                homeworkQuestions = data;
            } else {
                // Ø£Ø³Ø¦Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©
                homeworkQuestions = [
                    { number: 1, text: "Ù…Ø§ Ø¹Ø§ØµÙ…Ø© Ù…ØµØ±ØŸ", correct: "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", options: ["Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©", "Ø§Ù„Ø¬ÙŠØ²Ø©", "Ø§Ù„Ø£Ù‚ØµØ±"] },
                    { number: 2, text: "ÙƒÙ… Ø¹Ø¯Ø¯ Ø­Ø±ÙˆÙ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŸ", correct: "28", options: ["26", "28", "30", "32"] },
                    { number: 3, text: "Ù…Ù† Ù‡Ùˆ Ù…Ø¤Ø³Ø³ Ø§Ù„Ø¯ÙˆÙ„Ø© Ø§Ù„Ø£Ù…ÙˆÙŠØ©ØŸ", correct: "Ù…Ø¹Ø§ÙˆÙŠØ© Ø¨Ù† Ø£Ø¨ÙŠ Ø³ÙÙŠØ§Ù†", options: ["Ø¹Ù…Ø± Ø¨Ù† Ø§Ù„Ø®Ø·Ø§Ø¨", "Ø¹Ù„ÙŠ Ø¨Ù† Ø£Ø¨ÙŠ Ø·Ø§Ù„Ø¨", "Ù…Ø¹Ø§ÙˆÙŠØ© Ø¨Ù† Ø£Ø¨ÙŠ Ø³ÙÙŠØ§Ù†", "Ø£Ø¨Ùˆ Ø¨ÙƒØ± Ø§Ù„ØµØ¯ÙŠÙ‚"] }
                ];
            }
            
            currentQuestionIndex = 0;
            userAnswers = {};
            displayQuestions();
            showQuestion(0);
            updateProgress();
            
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('formScreen').style.display = 'none';
            document.getElementById('questionsScreen').style.display = 'block';
            
        } catch (error) {
            console.error('Ø®Ø·Ø£:', error);
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø³Ø¦Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©');
            
            homeworkQuestions = [
                { number: 1, text: "Ù…Ø§ Ø¹Ø§ØµÙ…Ø© Ù…ØµØ±ØŸ", correct: "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", options: ["Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©", "Ø§Ù„Ø¬ÙŠØ²Ø©", "Ø§Ù„Ø£Ù‚ØµØ±"] },
                { number: 2, text: "ÙƒÙ… Ø¹Ø¯Ø¯ Ø­Ø±ÙˆÙ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŸ", correct: "28", options: ["26", "28", "30", "32"] },
                { number: 3, text: "Ù…Ù† Ù‡Ùˆ Ù…Ø¤Ø³Ø³ Ø§Ù„Ø¯ÙˆÙ„Ø© Ø§Ù„Ø£Ù…ÙˆÙŠØ©ØŸ", correct: "Ù…Ø¹Ø§ÙˆÙŠØ© Ø¨Ù† Ø£Ø¨ÙŠ Ø³ÙÙŠØ§Ù†", options: ["Ø¹Ù…Ø± Ø¨Ù† Ø§Ù„Ø®Ø·Ø§Ø¨", "Ø¹Ù„ÙŠ Ø¨Ù† Ø£Ø¨ÙŠ Ø·Ø§Ù„Ø¨", "Ù…Ø¹Ø§ÙˆÙŠØ© Ø¨Ù† Ø£Ø¨ÙŠ Ø³ÙÙŠØ§Ù†", "Ø£Ø¨Ùˆ Ø¨ÙƒØ± Ø§Ù„ØµØ¯ÙŠÙ‚"] }
            ];
            
            currentQuestionIndex = 0;
            userAnswers = {};
            displayQuestions();
            showQuestion(0);
            updateProgress();
            
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('formScreen').style.display = 'none';
            document.getElementById('questionsScreen').style.display = 'block';
        }
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
    function displayQuestions() {
        const container = document.getElementById('questionsContainer');
        container.innerHTML = '';
        
        homeworkQuestions.forEach((q, idx) => {
            const div = document.createElement('div');
            div.className = 'question-card';
            div.id = `q-${idx}`;
            
            let html = `<div class="question-text">${idx + 1}. ${q.text || 'Ø§Ù„Ø³Ø¤Ø§Ù„'}</div>`;
            html += '<div class="options">';
            
            const options = q.options || ['Ø§', 'Ø¨', 'Ø¬', 'Ø¯'];
            options.forEach((opt, optIdx) => {
                html += `
                    <label class="option">
                        <input type="radio" name="q${idx}" value="${opt}" onchange="saveAnswer(${idx}, '${opt}')">
                        <span>${opt}</span>
                    </label>
                `;
            });
            
            html += '</div>';
            div.innerHTML = html;
            container.appendChild(div);
        });
    }

    // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
    function saveAnswer(qIdx, answer) {
        userAnswers[qIdx] = answer;
    }

    // Ø¹Ø±Ø¶ Ø³Ø¤Ø§Ù„
    function showQuestion(idx) {
        document.querySelectorAll('.question-card').forEach(q => q.classList.remove('active'));
        document.getElementById(`q-${idx}`).classList.add('active');
        
        document.getElementById('prevBtn').style.visibility = idx === 0 ? 'hidden' : 'visible';
        
        if (idx === homeworkQuestions.length - 1) {
            document.getElementById('nextBtn').innerHTML = 'Ø¥Ù†Ù‡Ø§Ø¡ <i class="fas fa-check"></i>';
        } else {
            document.getElementById('nextBtn').innerHTML = 'Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-arrow-left"></i>';
        }
    }

    // Ø§Ù„ØªØ§Ù„ÙŠ
    function nextQuestion() {
        if (currentQuestionIndex < homeworkQuestions.length - 1) {
            currentQuestionIndex++;
            showQuestion(currentQuestionIndex);
            updateProgress();
        } else {
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('prevBtn').style.display = 'none';
            document.getElementById('completedMessage').style.display = 'block';
            document.getElementById('submitButtons').style.display = 'block';
        }
    }

    // Ø§Ù„Ø³Ø§Ø¨Ù‚
    function prevQuestion() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            showQuestion(currentQuestionIndex);
            updateProgress();
            document.getElementById('nextBtn').style.display = 'block';
            document.getElementById('prevBtn').style.display = 'block';
            document.getElementById('completedMessage').style.display = 'none';
            document.getElementById('submitButtons').style.display = 'none';
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù…
    function updateProgress() {
        const progress = ((currentQuestionIndex + 1) / homeworkQuestions.length) * 100;
        document.getElementById('progressBar').style.width = `${progress}%`;
        document.getElementById('currentQuestion').innerHTML = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestionIndex + 1} Ù…Ù† ${homeworkQuestions.length}`;
        document.getElementById('progressPercent').innerHTML = `${Math.round(progress)}%`;
    }

    // ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙˆØ§Ø¬Ø¨
    function submitHomework() {
        const name = document.getElementById('studentName').value;
        const mobile = document.getElementById('studentMobile').value;
        
        let score = 0;
        const reviewRows = [];
        
        homeworkQuestions.forEach((q, idx) => {
            const userAnswer = userAnswers[idx] || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©';
            const isCorrect = userAnswer === q.correct;
            if (isCorrect) score++;
            
            reviewRows.push({
                question: q.text,
                userAnswer: userAnswer,
                correctAnswer: q.correct,
                isCorrect: isCorrect
            });
        });
        
        const total = homeworkQuestions.length;
        const percentage = Math.round((score / total) * 100);
        
        // Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
        const tableBody = document.getElementById('reviewTableBody');
        tableBody.innerHTML = reviewRows.map(row => `
            <tr>
                <td>${row.question}</td>
                <td class="${row.isCorrect ? 'correct-answer' : 'wrong-answer'}">${row.userAnswer}</td>
                <td class="correct-answer">${row.correctAnswer}</td>
                <td>
                    ${row.isCorrect ? 
                        '<span class="icon-correct"><i class="fas fa-check-circle"></i> ØµØ­</span>' : 
                        '<span class="icon-wrong"><i class="fas fa-times-circle"></i> Ø®Ø·Ø£</span>'
                    }
                </td>
            </tr>
        `).join('');
        
        // Ø¥Ù†Ø´Ø§Ø¡ QR
        const qrData = `Ø§Ù„ÙˆØ§Ø¬Ø¨: ${currentHomework?.title || 'Ø§Ù„ÙˆØ§Ø¬Ø¨'}\nØ§Ù„Ø·Ø§Ù„Ø¨: ${name}\nØ§Ù„Ø¯Ø±Ø¬Ø©: ${score}/${total} (${percentage}%)`;
        
        document.getElementById('qrContainer').innerHTML = '';
        try {
            const qr = kjua({ text: qrData, size: 200, render: 'canvas' });
            document.getElementById('qrContainer').appendChild(qr);
        } catch (e) {
            document.getElementById('qrContainer').innerHTML = '<p>Ø­Ø¯Ø« Ø®Ø·Ø£</p>';
        }
        
        document.getElementById('studentDetails').innerHTML = `
            <strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${name}<br>
            <strong>Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„:</strong> ${mobile}<br>
            <strong>Ø§Ù„ÙˆØ§Ø¬Ø¨:</strong> ${currentHomework?.title || 'Ø§Ù„ÙˆØ§Ø¬Ø¨'}<br>
            <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date().toLocaleDateString('ar-EG')}
        `;
        
        document.getElementById('scoreDisplay').innerHTML = `${score}/${total} (${percentage}%)`;
        
        let advice = percentage >= 70 ? 'ğŸ‰ Ù…Ù…ØªØ§Ø² ÙŠØ§ Ø¨Ø·Ù„! Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªØ£Ù„Ù‚' : 'ğŸ’ª Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ÙˆØ§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªØ¹Ù„Ù…';
        document.getElementById('adviceText').innerHTML = advice;
        
        document.getElementById('questionsScreen').style.display = 'none';
        document.getElementById('resultScreen').style.display = 'block';
    }

    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
    function resetApp() {
        document.getElementById('resultScreen').style.display = 'none';
        document.getElementById('homeworkListScreen').style.display = 'block';
        document.getElementById('studentName').value = '';
        document.getElementById('studentMobile').value = '';
        document.getElementById('privacyCheck').checked = false;
    }
</script>
</body>
</html>
