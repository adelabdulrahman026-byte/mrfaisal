<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>طلب شراء منتجات</title>
<style>
  /* Reset */
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Cairo', sans-serif;
    margin: 0; padding: 20px;
    background: #eef4f9;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1 {
    color: #0b72b9;
    margin-bottom: 30px;
    text-align: center;
  }
  .cards {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: center;
    width: 100%;
    max-width: 960px;
  }
  .card {
    background: white;
    width: 320px;
    border-radius: 15px;
    box-shadow: 0 6px 15px rgb(0 0 0 / 0.1);
    cursor: pointer;
    transition: transform 0.3s ease;
    position: relative;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .card:hover {
    transform: translateY(-8px);
  }
  .card video {
    width: 100%;
    height: 180px;
    object-fit: cover;
  }
  .card .title {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #0b72b9;
    color: white;
    padding: 7px 14px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 16px;
    user-select: none;
  }
  .card .desc {
    padding: 15px 20px 5px;
    color: #333;
    font-size: 14px;
    flex-grow: 1;
  }
  .card .price {
    padding: 0 20px 15px;
    font-weight: bold;
    font-size: 18px;
    color: #009688;
  }

  /* مودال */
  #modalOverlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    z-index: 9999;
    padding: 20px;
  }
  #modal {
    background: white;
    border-radius: 15px;
    max-width: 480px;
    width: 100%;
    padding: 25px 30px;
    box-shadow: 0 0 30px rgba(0,0,0,0.3);
    position: relative;
  }
  #modalClose {
    position: absolute;
    top: 12px; left: 15px;
    font-size: 25px;
    font-weight: bold;
    cursor: pointer;
    color: #999;
  }
  #modalClose:hover {
    color: #0b72b9;
  }
  #modal h2 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #0b72b9;
    text-align: center;
  }
  #modal p {
    font-size: 14px;
    margin-bottom: 15px;
    color: #444;
  }
  #modal form label {
    display: block;
    margin: 10px 0 6px;
    font-weight: 600;
  }
  #modal form input[type=text],
  #modal form input[type=tel],
  #modal form select,
  #modal form input[type=file] {
    width: 100%;
    padding: 10px 12px;
    font-size: 14px;
    border-radius: 7px;
    border: 1px solid #ccc;
  }
  #modal form button {
    margin-top: 20px;
    width: 100%;
    background: #0b72b9;
    border: none;
    color: white;
    font-weight: bold;
    font-size: 17px;
    padding: 12px 0;
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  #modal form button:disabled {
    background: #aaa;
    cursor: not-allowed;
  }
  #modal form button:hover:not(:disabled) {
    background: #084a6a;
  }
  #loading, #successMsg, #errorMsg {
    margin-top: 15px;
    text-align: center;
    font-weight: bold;
  }
  #loading {
    color: #0b72b9;
  }
  #successMsg {
    color: #4caf50;
    font-size: 18px;
  }
  #errorMsg {
    color: #e53935;
    font-size: 16px;
  }
  .tracking-code {
    margin-top: 10px;
    padding: 10px 15px;
    background: #e0f7f1;
    font-family: monospace;
    cursor: pointer;
    user-select: all;
    border-radius: 10px;
    display: inline-block;
  }
</style>
<script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.6.2/dist/dotlottie-wc.js" type="module"></script>
</head>
<body>

<h1>اختر منتجك واطلب الآن</h1>

<div class="cards">
  <div class="card" data-name="مذكرات الصف الثالث الثانوي" data-desc="مذكرة كاملة للصف الثالث الثانوي" data-price="230" data-type="product">
    <div class="title">مذكرات الصف الثالث الثانوي</div>
    <video src="https://files.catbox.moe/lgvvn8.mp4" autoplay muted loop playsinline></video>
    <div class="desc">مذكرة كاملة للصف الثالث الثانوي</div>
    <div class="price">السعر: 230 جنيه</div>
  </div>
  <div class="card" data-name="مذكرات الصف الثاني الثانوي" data-desc="مذكرة كاملة للصف الثاني الثانوي" data-price="200" data-type="product">
    <div class="title">مذكرات الصف الثاني الثانوي</div>
    <video src="https://files.catbox.moe/lgvvn8.mp4" autoplay muted loop playsinline></video>
    <div class="desc">مذكرة كاملة للصف الثاني الثانوي</div>
    <div class="price">السعر: 200 جنيه</div>
  </div>
  <div class="card" data-name="اشتري كود اونلاين" data-desc="كود تفعيل للدروس الأونلاين" data-price="150" data-type="code">
    <div class="title">اشتري كود اونلاين</div>
    <video src="https://files.catbox.moe/lgvvn8.mp4" autoplay muted loop playsinline></video>
    <div class="desc">كود تفعيل للدروس الأونلاين</div>
    <div class="price">السعر: 150 جنيه</div>
  </div>
</div>

<div id="modalOverlay" style="display:none; align-items:center; justify-content:center;">
  <div id="modal">
    <div id="modalClose">&times;</div>
    <h2 id="modalTitle"></h2>
    <p id="modalDesc"></p>
    <p><strong>السعر: </strong><span id="modalPrice"></span> جنيه</p>
    <form id="orderForm">
      <label for="fullName">الاسم ثنائي:</label>
      <input type="text" id="fullName" name="fullName" required autocomplete="off" />

      <label for="province">المحافظة:</label>
      <input type="text" id="province" name="province" required autocomplete="off" />

      <label for="address">العنوان بالتفاصيل:</label>
      <input type="text" id="address" name="address" required autocomplete="off" />

      <label for="phoneContact">رقم الهاتف للتواصل:</label>
      <input type="tel" id="phoneContact" name="phoneContact" required pattern="[0-9]{10,15}" autocomplete="off" />

      <label for="phoneTransfer">رقم الهاتف المحول منه المبلغ:</label>
      <input type="tel" id="phoneTransfer" name="phoneTransfer" required pattern="[0-9]{10,15}" autocomplete="off" />

      <div id="codeTypeDiv" style="display:none;">
        <label for="codeType">نوع الكود:</label>
        <select id="codeType" name="codeType">
          <option value="">اختر نوع الكود</option>
          <option value="ثانوي">ثانوي</option>
          <option value="ثالثة">ثالثة</option>
          <option value="آخر">آخر</option>
        </select>
      </div>

      <label for="transferImage">رفع صورة التحويل:</label>
      <input type="file" id="transferImage" name="transferImage" accept="image/*" required />

      <button type="submit" id="buyBtn">يلا اشتري</button>
    </form>

    <div id="loading" style="display:none;">
      <dotlottie-wc src="https://lottie.host/1d706623-ba9d-4493-b516-a89415725aab/5xTwGriKjM.lottie" style="width:150px;height:150px;" autoplay loop></dotlottie-wc>
      <p>جاري الشحن ...</p>
    </div>

    <div id="successMsg" style="display:none;">
      <div style="font-size: 80px; color: #4caf50; animation: bounce 1.5s infinite;">✔️</div>
      <p>تم الشحن بنجاح!</p>
      <div id="orderDetails"></div>
      <p>كود التتبع:</p>
      <div class="tracking-code" id="trackingCode" title="اضغط للنسخ"></div>
      <p style="font-size: 14px; color: #555;">خد اسكرين أو احفظ كود التتبع كويس عشان تعرف طلبك وصل لفين.</p>
    </div>

    <div id="errorMsg" style="color:#e53935; font-weight:bold; display:none; margin-top:15px;"></div>
  </div>
</div>

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxi8zVjJ3WrHoYrNxfaXOuUW3ZlIL3BdxDG3pFSRpLWXx7XST7bHksjA8VJ8n50oiK6/exec";

  const cards = document.querySelectorAll('.card');
  const modalOverlay = document.getElementById('modalOverlay');
  const modal = document.getElementById('modal');
  const modalClose = document.getElementById('modalClose');
  const modalTitle = document.getElementById('modalTitle');
  const modalDesc = document.getElementById('modalDesc');
  const modalPrice = document.getElementById('modalPrice');

  const orderForm = document.getElementById('orderForm');
  const buyBtn = document.getElementById('buyBtn');
  const codeTypeDiv = document.getElementById('codeTypeDiv');
  const codeTypeSelect = document.getElementById('codeType');
  const transferImageInput = document.getElementById('transferImage');

  const loading = document.getElementById('loading');
  const successMsg = document.getElementById('successMsg');
  const errorMsg = document.getElementById('errorMsg');
  const orderDetails = document.getElementById('orderDetails');
  const trackingCodeEl = document.getElementById('trackingCode');

  let currentProduct = null;

  // فتح المودال عند الضغط على كارت
  cards.forEach(card => {
    card.addEventListener('click', () => {
      currentProduct = {
        name: card.dataset.name,
        desc: card.dataset.desc,
        price: card.dataset.price,
        type: card.dataset.type
      };
      modalTitle.textContent = currentProduct.name;
      modalDesc.textContent = currentProduct.desc;
      modalPrice.textContent = currentProduct.price;

      if(currentProduct.type === "code"){
        codeTypeDiv.style.display = "block";
      } else {
        codeTypeDiv.style.display = "none";
        codeTypeSelect.value = "";
      }

      // إعادة تعيين النموذج
      orderForm.reset();
      errorMsg.style.display = "none";
      successMsg.style.display = "none";
      loading.style.display = "none";
      buyBtn.disabled = false;
      orderForm.style.display = "block";

      modalOverlay.style.display = "flex";
    });
  });

  modalClose.addEventListener('click', () => {
    modalOverlay.style.display = "none";
  });
  modalOverlay.addEventListener('click', e => {
    if(e.target === modalOverlay){
      modalOverlay.style.display = "none";
    }
  });

  trackingCodeEl.addEventListener('click', () => {
    const code = trackingCodeEl.textContent;
    navigator.clipboard.writeText(code);
    alert("تم نسخ كود التتبع");
  });

  // لتحويل ملف الصورة إلى base64
  function getBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
      reader.readAsDataURL(file);
    });
  }

  orderForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorMsg.style.display = "none";

    if(transferImageInput.files.length === 0){
      showError("يرجى رفع صورة التحويل");
      return;
    }

    buyBtn.disabled = true;
    loading.style.display = "block";
    orderForm.style.display = "none";

    const base64Image = await getBase64(transferImageInput.files[0]);

    const dataToSend = {
      fullName: orderForm.fullName.value.trim(),
      province: orderForm.province.value.trim(),
      address: orderForm.address.value.trim(),
      phoneContact: orderForm.phoneContact.value.trim(),
      phoneTransfer: orderForm.phoneTransfer.value.trim(),
      productName: currentProduct.name,
      productPrice: currentProduct.price,
      transferImageBase64: base64Image,
      codeType: codeTypeSelect.value || ""
    };

    // تحقق من تعبئة الكود إذا المنتج "كود"
    if(currentProduct.type === "code" && !dataToSend.codeType){
      showError("يرجى اختيار نوع الكود");
      loading.style.display = "none";
      orderForm.style.display = "block";
      buyBtn.disabled = false;
      return;
    }

    try {
      const response = await fetch(WEB_APP_URL, {
        method: "POST",
        body: JSON.stringify(dataToSend),
        headers: {"Content-Type": "application/json"}
      });
      const result = await response.json();

      if(result.status === "success"){
        successMsg.style.display = "block";
        orderDetails.innerHTML = `
          <p><strong>الاسم:</strong> ${result.data.fullName}</p>
          <p><strong>المحافظة:</strong> ${result.data.province}</p>
          <p><strong>العنوان:</strong> ${result.data.address}</p>
          <p><strong>رقم التواصل:</strong> ${result.data.phoneContact}</p>
          <p><strong>رقم المحول:</strong> ${result.data.phoneTransfer}</p>
        `;
        trackingCodeEl.textContent = result.data.trackingCode;

        loading.style.display = "none";
      } else {
        showError(result.message || "حدث خطأ أثناء الطلب");
        loading.style.display = "none";
        orderForm.style.display = "block";
        buyBtn.disabled = false;
      }

    } catch(err){
      showError("خطأ في الاتصال بالخادم، حاول مرة أخرى");
      loading.style.display = "none";
      orderForm.style.display = "block";
      buyBtn.disabled = false;
    }
  });

  function showError(msg){
    errorMsg.textContent = msg;
    errorMsg.style.display = "block";
  }
</script>

</body>
</html>
