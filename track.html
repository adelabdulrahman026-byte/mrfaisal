<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>طلب شراء المنتجات</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo&display=swap');
    body {
      font-family: 'Cairo', sans-serif;
      background: #f0f4f8;
      margin: 0; padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #222;
    }
    h1 {
      color: #0066cc;
      margin-bottom: 30px;
    }
    .cards {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      max-width: 1000px;
      width: 100%;
    }
    .card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.1);
      width: 300px;
      cursor: pointer;
      transition: transform 0.3s ease;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .card:hover {
      transform: translateY(-10px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    .card video {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }
    .title {
      position: absolute;
      top: 12px;
      left: 12px;
      background: #0066cc;
      color: white;
      padding: 8px 20px;
      border-radius: 25px;
      font-weight: 700;
      font-size: 16px;
      box-shadow: 0 3px 10px rgba(0,102,204,0.5);
      z-index: 10;
    }
    .desc {
      padding: 15px 18px 5px;
      font-size: 15px;
      color: #444;
      flex-grow: 1;
    }
    .price {
      padding: 0 18px 15px;
      font-weight: 700;
      font-size: 18px;
      color: #009688;
    }
    button {
      background: #0066cc;
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 700;
      padding: 12px 0;
      cursor: pointer;
      font-size: 17px;
      margin-top: 10px;
      transition: background 0.3s ease;
    }
    button:hover:not(:disabled) {
      background: #004999;
    }
    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    /* المودال */
    .modalOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 15px;
    }
    .modal {
      background: white;
      border-radius: 15px;
      max-width: 460px;
      width: 100%;
      padding: 25px 30px;
      box-shadow: 0 0 30px rgba(0,0,0,0.25);
      position: relative;
      text-align: center;
    }
    .modalClose {
      position: absolute;
      top: 12px;
      left: 12px;
      font-size: 28px;
      font-weight: 700;
      cursor: pointer;
      color: #777;
      user-select: none;
      transition: color 0.3s ease;
    }
    .modalClose:hover {
      color: #0066cc;
    }
    form label {
      display: block;
      margin: 12px 0 6px;
      font-weight: 600;
      text-align: right;
    }
    form input[type=text], form input[type=tel], form select, form input[type=file] {
      width: 100%;
      padding: 10px 12px;
      font-size: 14px;
      border-radius: 7px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    #loading, #successMsg, #errorMsg {
      margin-top: 15px;
      font-weight: 700;
    }
    #loading {
      color: #0066cc;
    }
    #successMsg {
      color: #4caf50;
      font-size: 19px;
    }
    #errorMsg {
      color: #e53935;
      font-size: 17px;
    }
    .tracking-code {
      margin-top: 12px;
      padding: 10px 15px;
      background: #e0f7f1;
      font-family: monospace;
      cursor: pointer;
      user-select: all;
      border-radius: 12px;
      display: inline-block;
      font-size: 18px;
    }
    .tracking-code:hover {
      background: #b2dfdb;
    }
    @media (max-width: 720px) {
      .cards {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
  <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.6.2/dist/dotlottie-wc.js" type="module"></script>
</head>
<body>

<h1>اختر منتجك واطلب الآن</h1>

<div class="cards">
  <div class="card" data-name="مذكرات الصف الثالث الثانوي" data-desc="مذكرة كاملة للصف الثالث الثانوي" data-price="230" data-type="product">
    <video src="https://files.catbox.moe/lgvvn8.mp4" autoplay muted loop playsinline></video>
    <div class="title">مذكرات الصف الثالث الثانوي</div>
    <div class="desc">مذكرة كاملة للصف الثالث الثانوي</div>
    <div class="price">السعر: 230 جنيه</div>
  </div>
  <div class="card" data-name="مذكرات الصف الثاني الثانوي" data-desc="مذكرة كاملة للصف الثاني الثانوي" data-price="200" data-type="product">
    <video src="https://files.catbox.moe/lgvvn8.mp4" autoplay muted loop playsinline></video>
    <div class="title">مذكرات الصف الثاني الثانوي</div>
    <div class="desc">مذكرة كاملة للصف الثاني الثانوي</div>
    <div class="price">السعر: 200 جنيه</div>
  </div>
  <div class="card" data-name="اشتري كود اونلاين" data-desc="كود تفعيل للدروس الأونلاين" data-price="150" data-type="code">
    <video src="https://files.catbox.moe/lgvvn8.mp4" autoplay muted loop playsinline></video>
    <div class="title">اشتري كود اونلاين</div>
    <div class="desc">كود تفعيل للدروس الأونلاين</div>
    <div class="price">السعر: 150 جنيه</div>
  </div>
</div>

<button id="trackOrderBtn" style="margin-top:30px; padding:12px 25px; font-weight:bold; background:#009688; color:#fff; border:none; border-radius:10px; cursor:pointer; box-shadow:0 5px 15px rgba(0,150,136,0.3);">تابع شحنك وصل لفين</button>

<!-- مودال الطلب -->
<div id="modalOverlay" class="modalOverlay">
  <div class="modal">
    <div id="modalClose" class="modalClose">&times;</div>
    <h2 id="modalTitle"></h2>
    <p id="modalDesc"></p>
    <p><strong>السعر: </strong><span id="modalPrice"></span> جنيه</p>
    <form id="orderForm">
      <label for="fullName">الاسم ثنائي:</label>
      <input type="text" id="fullName" name="fullName" required autocomplete="off" />

      <label for="province">المحافظة:</label>
      <input type="text" id="province" name="province" required autocomplete="off" />

      <label for="address">العنوان بالتفاصيل:</label>
      <input type="text" id="address" name="address" required autocomplete="off" />

      <label for="phoneContact">رقم الهاتف للتواصل:</label>
      <input type="tel" id="phoneContact" name="phoneContact" required pattern="[0-9]{10,15}" autocomplete="off" />

      <label for="phoneTransfer">رقم الهاتف المحول منه المبلغ:</label>
      <input type="tel" id="phoneTransfer" name="phoneTransfer" required pattern="[0-9]{10,15}" autocomplete="off" />

      <div id="codeTypeDiv" style="display:none;">
        <label for="codeType">نوع الكود:</label>
        <select id="codeType" name="codeType">
          <option value="">اختر نوع الكود</option>
          <option value="ثانوي">ثانوي</option>
          <option value="ثالثة">ثالثة</option>
          <option value="آخر">آخر</option>
        </select>
      </div>

      <label for="transferImage">رفع صورة التحويل:</label>
      <input type="file" id="transferImage" name="transferImage" accept="image/*" required />

      <button type="submit" id="buyBtn">يلا اشتري</button>
    </form>

    <div id="loading" style="display:none; margin-top: 20px;">
      <dotlottie-wc src="https://lottie.host/1d706623-ba9d-4493-b516-a89415725aab/5xTwGriKjM.lottie" style="width:150px;height:150px;" autoplay loop></dotlottie-wc>
      <p>جاري الشحن ...</p>
    </div>

    <div id="successMsg" style="display:none; margin-top: 20px;">
      <div style="font-size: 80px; color: #4caf50; animation: bounce 1.5s infinite;">✔️</div>
      <p>تم الشحن بنجاح!</p>
      <div id="orderDetails" style="text-align:right;"></div>
      <p>كود التتبع:</p>
      <div class="tracking-code" id="trackingCode" title="اضغط للنسخ"></div>
      <p style="font-size: 14px; color: #555;">خد اسكرين أو احفظ كود التتبع كويس عشان تعرف طلبك وصل لفين.</p>
    </div>

    <div id="errorMsg" style="color:#e53935; font-weight:bold; display:none; margin-top:15px;"></div>
  </div>
</div>

<!-- مودال تتبع الطلب -->
<div id="trackModalOverlay" class="modalOverlay">
  <div class="modal" style="max-width: 400px;">
    <div id="trackModalClose" class="modalClose">&times;</div>
    <h2>تابع طلبك</h2>
    <form id="trackForm">
      <label for="trackingInput">ادخل كود التتبع:</label>
      <input type="text" id="trackingInput" name="trackingInput" required autocomplete="off" />
      <button type="submit" style="margin-top: 12px;">ابحث</button>
    </form>
    <div id="trackResult" style="margin-top: 15px; text-align:right;"></div>
  </div>
</div>

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxYY77Tqhw8Bn4pW8Tl31e_y0fITgwd58Ear_r9OD7eGKmGPnYzkTvl83imyfsIG3oY/exec";

  const cards = document.querySelectorAll('.card');
  const modalOverlay = document.getElementById('modalOverlay');
  const modalClose = document.getElementById('modalClose');
  const modalTitle = document.getElementById('modalTitle');
  const modalDesc = document.getElementById('modalDesc');
  const modalPrice = document.getElementById('modalPrice');
  const orderForm = document.getElementById('orderForm');
  const errorMsg = document.getElementById('errorMsg');
  const successMsg = document.getElementById('successMsg');
  const loading = document.getElementById('loading');
  const orderDetails = document.getElementById('orderDetails');
  const trackingCodeEl = document.getElementById('trackingCode');
  const buyBtn = document.getElementById('buyBtn');

  const codeTypeDiv = document.getElementById('codeTypeDiv');
  const codeTypeSelect = document.getElementById('codeType');

  let currentProduct = null;

  cards.forEach(card => {
    card.addEventListener('click', () => {
      currentProduct = {
        name: card.dataset.name,
        desc: card.dataset.desc,
        price: card.dataset.price,
        type: card.dataset.type
      };
      modalTitle.textContent = currentProduct.name;
      modalDesc.textContent = currentProduct.desc;
      modalPrice.textContent = currentProduct.price;

      if(currentProduct.type === "code"){
        codeTypeDiv.style.display = "block";
        codeTypeSelect.required = true;
      } else {
        codeTypeDiv.style.display = "none";
        codeTypeSelect.required = false;
        codeTypeSelect.value = "";
      }

      orderForm.reset();
      errorMsg.style.display = "none";
      successMsg.style.display = "none";
      loading.style.display = "none";
      orderForm.style.display = "block";
      buyBtn.disabled = false;

      modalOverlay.style.display = "flex";
    });
  });

  modalClose.onclick = () => {
    modalOverlay.style.display = "none";
  };

  trackingCodeEl.onclick = () => {
    const range = document.createRange();
    range.selectNode(trackingCodeEl);
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
    document.execCommand('copy');
    alert('تم نسخ كود التتبع');
  };

  orderForm.addEventListener('submit', (e) => {
    e.preventDefault();

    if(!orderForm.checkValidity()){
      errorMsg.textContent = "يرجى تعبئة جميع الحقول بشكل صحيح.";
      errorMsg.style.display = "block";
      return;
    }
    if(currentProduct.type === "code" && !codeTypeSelect.value){
      errorMsg.textContent = "يرجى اختيار نوع الكود.";
      errorMsg.style.display = "block";
      return;
    }
    if(document.getElementById('transferImage').files.length === 0){
      errorMsg.textContent = "يرجى رفع صورة التحويل.";
      errorMsg.style.display = "block";
      return;
    }

    errorMsg.style.display = "none";
    orderForm.style.display = "none";
    loading.style.display = "block";
    buyBtn.disabled = true;

    const file = document.getElementById('transferImage').files[0];
    const reader = new FileReader();

    reader.onload = function() {
      const transferImageBase64 = reader.result;

      const dataToSend = {
        fullName: orderForm.fullName.value.trim(),
        province: orderForm.province.value.trim(),
        address: orderForm.address.value.trim(),
        phoneContact: orderForm.phoneContact.value.trim(),
        phoneTransfer: orderForm.phoneTransfer.value.trim(),
        productName: currentProduct.name,
        productPrice: currentProduct.price,
        codeType: codeTypeSelect.value,
        transferImageBase64
      };

      fetch(WEB_APP_URL, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(dataToSend)
      })
      .then(res => res.json())
      .then(result => {
        if(result.status === "success"){
          successMsg.style.display = "block";
          orderDetails.innerHTML = `
            <p><strong>الاسم:</strong> ${result.data.fullName}</p>
            <p><strong>المحافظة:</strong> ${result.data.province}</p>
            <p><strong>العنوان:</strong> ${result.data.address}</p>
            <p><strong>رقم التواصل:</strong> ${result.data.phoneContact}</p>
            <p><strong>رقم المحول:</strong> ${result.data.phoneTransfer}</p>
          `;
          trackingCodeEl.textContent = result.data.trackingCode;

          loading.style.display = "none";
        } else {
          errorMsg.textContent = result.message || "حدث خطأ أثناء الطلب";
          errorMsg.style.display = "block";
          loading.style.display = "none";
          orderForm.style.display = "block";
          buyBtn.disabled = false;
        }
      })
      .catch(() => {
        errorMsg.textContent = "خطأ في الاتصال بالخادم، حاول مرة أخرى";
        errorMsg.style.display = "block";
        loading.style.display = "none";
        orderForm.style.display = "block";
        buyBtn.disabled = false;
      });
    };

    reader.readAsDataURL(file);
  });

  // مودال تتبع الطلب
  const trackOrderBtn = document.getElementById('trackOrderBtn');
  const trackModalOverlay = document.getElementById('trackModalOverlay');
  const trackModalClose = document.getElementById('trackModalClose');
  const trackForm = document.getElementById('trackForm');
  const trackResult = document.getElementById('trackResult');

  trackOrderBtn.onclick = () => {
    trackResult.textContent = "";
    trackForm.reset();
    trackModalOverlay.style.display = "flex";
  };
  trackModalClose.onclick = () => {
    trackModalOverlay.style.display = "none";
  };

  trackForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const code = trackForm.trackingInput.value.trim();
    if(code.length === 0){
      trackResult.textContent = "ادخل كود التتبع!";
      return;
    }
    trackResult.textContent = "جاري البحث...";
    fetch(WEB_APP_URL + "?action=track&code=" + encodeURIComponent(code))
      .then(res => res.json())
      .then(data => {
        if(data.status === "success" && data.data){
          trackResult.innerHTML = `
            <p><strong>الاسم:</strong> ${data.data.fullName}</p>
            <p><strong>المحافظة:</strong> ${data.data.province}</p>
            <p><strong>العنوان:</strong> ${data.data.address}</p>
            <p><strong>رقم التواصل:</strong> ${data.data.phoneContact}</p>
            <p><strong>رقم المحول:</strong> ${data.data.phoneTransfer}</p>
            <p><strong>حالة الشحن:</strong> ${data.data.shippingStatus}</p>
            <p><strong>السعر:</strong> ${data.data.price} جنيه</p>
            <p><strong>تاريخ الطلب:</strong> ${new Date(data.data.date).toLocaleString()}</p>
          `;
        } else {
          trackResult.textContent = data.message || "كود التتبع غير موجود.";
        }
      })
      .catch(() => {
        trackResult.textContent = "خطأ في الاتصال بالخادم، حاول مرة أخرى.";
      });
  });
</script>

<style>
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
  }
</style>

</body>
</html>
