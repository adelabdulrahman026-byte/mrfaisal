<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نموذج الطلب</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; padding: 20px; }
    form { background: white; padding:20px; border-radius:10px; max-width:500px; margin:auto; }
    label { display:block; margin-top:15px; font-weight:bold; }
    input, select { width:100%; padding:10px; margin-top:5px; border:1px solid #ccc; border-radius:5px; }
    button { margin-top:20px; padding:15px; width:100%; background:#28a745; color:#fff; font-size:18px; border:none; border-radius:8px; cursor:pointer; }
    button:hover { background:#218838; }
    #message { margin-top:15px; text-align:center; font-weight:bold; }
  </style>
</head>
<body>

<form id="orderForm">
  <label for="name">الاسم الكامل</label>
  <input type="text" id="name" required />

  <label for="phone">رقم الهاتف</label>
  <input type="tel" id="phone" pattern="[0-9]+" required />

  <label for="product">المنتج</label>
  <select id="product" required>
    <option value="مذكرة الصف الثالث الثانوي">مذكرة الصف الثالث الثانوي</option>
  </select>

  <label for="price">السعر</label>
  <input type="number" id="price" value="200" readonly />

  <label for="shipping">الشحن</label>
  <input type="number" id="shipping" value="30" readonly />

  <label for="total">الإجمالي</label>
  <input type="number" id="total" value="230" readonly />

  <label for="vodafoneNumber">رقم فودافون كاش</label>
  <input type="tel" id="vodafoneNumber" pattern="[0-9]+" required />

  <label for="image">رفع صورة تحويل فودافون كاش</label>
  <input type="file" id="image" accept="image/*" required />

  <button type="submit">إرسال الطلب</button>

  <div id="message"></div>
</form>

<script>
  const form = document.getElementById('orderForm');
  const messageDiv = document.getElementById('message');
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyRkLmFu0DQlNASGA0DTD5bgoJdjtxOMAIatcDWR0pXxdI3bL9bfJ-d2yc_zFokFvmHwQ/exec";

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    messageDiv.textContent = "جاري إرسال الطلب...";

    // تحقق من وجود ملف صورة
    const imageInput = document.getElementById('image');
    if (!imageInput.files.length) {
      messageDiv.textContent = "من فضلك ارفع صورة تحويل فودافون كاش.";
      return;
    }
    const file = imageInput.files[0];

    // دالة لتحويل الملف إلى Base64
    const toBase64 = file => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
    });

    let imageBase64;
    try {
      imageBase64 = await toBase64(file);
    } catch (err) {
      messageDiv.textContent = "فشل في قراءة صورة التحويل.";
      return;
    }

    // جهز البيانات للإرسال
    const data = {
      name: document.getElementById('name').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      product: document.getElementById('product').value,
      price: Number(document.getElementById('price').value),
      shipping: Number(document.getElementById('shipping').value),
      total: Number(document.getElementById('total').value),
      vodafoneNumber: document.getElementById('vodafoneNumber').value.trim(),
      imageBase64: imageBase64
    };

    try {
      const response = await fetch(SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (result.status === "success") {
        messageDiv.style.color = "green";
        messageDiv.textContent = "تم إرسال الطلب بنجاح. كود التتبع: " + result.trackingCode;
        form.reset();
      } else {
        messageDiv.style.color = "red";
        messageDiv.textContent = "خطأ: " + (result.message || "حدث خطأ أثناء إرسال الطلب.");
      }
    } catch (err) {
      messageDiv.style.color = "red";
      messageDiv.textContent = "حدث خطأ في الاتصال بالخادم. حاول مرة أخرى.";
    }
  });
</script>

</body>
</html>
