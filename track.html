<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>طلب شراء المنتجات</title>
<style>
  body {
    font-family: 'Cairo', sans-serif;
    background: #f0f4f8;
    margin: 0; padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1 {
    color: #0077cc;
    margin-bottom: 25px;
    text-align: center;
  }
  .cards {
    display: flex;
    flex-wrap: wrap;
    gap: 18px;
    justify-content: center;
    max-width: 1000px;
    width: 100%;
  }
  .card {
    background: #fff;
    border-radius: 12px;
    width: 320px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    cursor: pointer;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: transform 0.3s ease;
  }
  .card:hover {
    transform: translateY(-6px);
  }
  .card video {
    width: 100%;
    height: 180px;
    object-fit: cover;
  }
  .card .title {
    position: absolute;
    background: #0077cc;
    color: #fff;
    padding: 7px 15px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 16px;
    margin: 10px;
    z-index: 10;
  }
  .card .desc {
    padding: 15px 18px 5px;
    color: #333;
    font-size: 14px;
    flex-grow: 1;
  }
  .card .price {
    padding: 0 18px 15px;
    font-weight: bold;
    font-size: 18px;
    color: #009688;
  }

  /* مودال */
  #modalOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.65);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    padding: 15px;
  }
  #modal {
    background: white;
    border-radius: 15px;
    max-width: 480px;
    width: 100%;
    padding: 25px 30px;
    box-shadow: 0 0 30px rgba(0,0,0,0.3);
    position: relative;
  }
  #modalClose {
    position: absolute;
    top: 15px; left: 15px;
    font-size: 26px;
    font-weight: bold;
    cursor: pointer;
    color: #999;
    user-select: none;
  }
  #modalClose:hover {
    color: #0077cc;
  }
  #modal h2 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #0077cc;
    text-align: center;
  }
  #modal p {
    font-size: 14px;
    margin-bottom: 15px;
    color: #444;
  }
  #modal form label {
    display: block;
    margin: 10px 0 6px;
    font-weight: 600;
  }
  #modal form input[type=text],
  #modal form input[type=tel],
  #modal form select,
  #modal form input[type=file] {
    width: 100%;
    padding: 10px 12px;
    font-size: 14px;
    border-radius: 7px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  #modal form button {
    margin-top: 20px;
    width: 100%;
    background: #0077cc;
    border: none;
    color: white;
    font-weight: bold;
    font-size: 17px;
    padding: 12px 0;
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  #modal form button:disabled {
    background: #aaa;
    cursor: not-allowed;
  }
  #modal form button:hover:not(:disabled) {
    background: #005fa3;
  }
  #loading, #successMsg, #errorMsg {
    margin-top: 15px;
    text-align: center;
    font-weight: bold;
  }
  #loading {
    color: #0077cc;
  }
  #successMsg {
    color: #4caf50;
    font-size: 18px;
  }
  #errorMsg {
    color: #e53935;
    font-size: 16px;
  }
  .tracking-code {
    margin-top: 10px;
    padding: 10px 15px;
    background: #e0f7f1;
    font-family: monospace;
    cursor: pointer;
    user-select: all;
    border-radius: 10px;
    display: inline-block;
  }

  @media(max-width: 700px){
    .cards {
      flex-direction: column;
      align-items: center;
    }
  }
</style>
<script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.6.2/dist/dotlottie-wc.js" type="module"></script>
</head>
<body>

<h1>اختر منتجك واطلب الآن</h1>

<div class="cards">
  <div class="card" data-name="مذكرات الصف الثالث الثانوي" data-desc="مذكرة كاملة للصف الثالث الثانوي" data-price="230" data-type="product">
    <video src="https://files.catbox.moe/lgvvn8.mp4" autoplay muted loop playsinline></video>
    <div class="title">مذكرات الصف الثالث الثانوي</div>
    <div class="desc">مذكرة كاملة للصف الثالث الثانوي</div>
    <div class="price">السعر: 230 جنيه</div>
  </div>
  <div class="card" data-name="مذكرات الصف الثاني الثانوي" data-desc="مذكرة كاملة للصف الثاني الثانوي" data-price="200" data-type="product">
    <video src="https://files.catbox.moe/lgvvn8.mp4" autoplay muted loop playsinline></video>
    <div class="title">مذكرات الصف الثاني الثانوي</div>
    <div class="desc">مذكرة كاملة للصف الثاني الثانوي</div>
    <div class="price">السعر: 200 جنيه</div>
  </div>
  <div class="card" data-name="اشتري كود اونلاين" data-desc="كود تفعيل للدروس الأونلاين" data-price="150" data-type="code">
    <video src="https://files.catbox.moe/lgvvn8.mp4" autoplay muted loop playsinline></video>
    <div class="title">اشتري كود اونلاين</div>
    <div class="desc">كود تفعيل للدروس الأونلاين</div>
    <div class="price">السعر: 150 جنيه</div>
  </div>
</div>

<div id="modalOverlay" style="display:none; align-items:center; justify-content:center;">
  <div id="modal">
    <div id="modalClose">&times;</div>
    <h2 id="modalTitle"></h2>
    <p id="modalDesc"></p>
    <p><strong>السعر: </strong><span id="modalPrice"></span> جنيه</p>
    <form id="orderForm">
      <label for="fullName">الاسم ثنائي:</label>
      <input type="text" id="fullName" name="fullName" required autocomplete="off" />

      <label for="province">المحافظة:</label>
      <input type="text" id="province" name="province" required autocomplete="off" />

      <label for="address">العنوان بالتفاصيل:</label>
      <input type="text" id="address" name="address" required autocomplete="off" />

      <label for="phoneContact">رقم الهاتف للتواصل:</label>
      <input type="tel" id="phoneContact" name="phoneContact" required pattern="[0-9]{10,15}" autocomplete="off" />

      <label for="phoneTransfer">رقم الهاتف المحول منه المبلغ:</label>
      <input type="tel" id="phoneTransfer" name="phoneTransfer" required pattern="[0-9]{10,15}" autocomplete="off" />

      <div id="codeTypeDiv" style="display:none;">
        <label for="codeType">نوع الكود:</label>
        <select id="codeType" name="codeType">
          <option value="">اختر نوع الكود</option>
          <option value="ثانوي">ثانوي</option>
          <option value="ثالثة">ثالثة</option>
          <option value="آخر">آخر</option>
        </select>
      </div>

      <label for="transferImage">رفع صورة التحويل:</label>
      <input type="file" id="transferImage" name="transferImage" accept="image/*" required />

      <button type="submit" id="buyBtn">يلا اشتري</button>
    </form>

    <div id="loading" style="display:none;">
      <dotlottie-wc src="https://lottie.host/1d706623-ba9d-4493-b516-a89415725aab/5xTwGriKjM.lottie" style="width:150px;height:150px;" autoplay loop></dotlottie-wc>
      <p>جاري الشحن ...</p>
    </div>

    <div id="successMsg" style="display:none;">
      <div style="font-size: 80px; color: #4caf50; animation: bounce 1.5s infinite;">✔️</div>
      <p>تم الشحن بنجاح!</p>
      <div id="orderDetails"></div>
      <p>كود التتبع:</p>
      <div class="tracking-code" id="trackingCode" title="اضغط للنسخ"></div>
      <p style="font-size: 14px; color: #555;">خد اسكرين أو احفظ كود التتبع كويس عشان تعرف طلبك وصل لفين.</p>
    </div>

    <div id="errorMsg" style="color:#e53935; font-weight:bold; display:none; margin-top:15px;"></div>
  </div>
</div>

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzymgsGpRLD6J7gyEBzackBhEEt_R0w_sHW2gZZpvd-q3id_jk0x8VZ4XCIW2HldrX4/exec";

  const cards = document.querySelectorAll('.card');
  const modalOverlay = document.getElementById('modalOverlay');
  const modal = document.getElementById('modal');
  const modalClose = document.getElementById('modalClose');
  const modalTitle = document.getElementById('modalTitle');
  const modalDesc = document.getElementById('modalDesc');
  const modalPrice = document.getElementById('modalPrice');

  const orderForm = document.getElementById('orderForm');
  const buyBtn = document.getElementById('buyBtn');
  const codeTypeDiv = document.getElementById('codeTypeDiv');
  const codeTypeSelect = document.getElementById('codeType');
  const transferImageInput = document.getElementById('transferImage');

  const loading = document.getElementById('loading');
  const successMsg = document.getElementById('successMsg');
  const errorMsg = document.getElementById('errorMsg');
  const orderDetails = document.getElementById('orderDetails');
  const trackingCodeEl = document.getElementById('trackingCode');

  let currentProduct = null;

  // فتح المودال عند الضغط على كارت
  cards.forEach(card => {
    card.addEventListener('click', () => {
      currentProduct = {
        name: card.dataset.name,
        desc: card.dataset.desc,
        price: card.dataset.price,
        type: card.dataset.type
      };
      modalTitle.textContent = currentProduct.name;
      modalDesc.textContent = currentProduct.desc;
      modalPrice.textContent = currentProduct.price;

      if(currentProduct.type === "code"){
        codeTypeDiv.style.display = "block";
      } else {
        codeTypeDiv.style.display = "none";
        codeTypeSelect.value = "";
      }

      orderForm.reset();
      errorMsg.style.display = "none";
      successMsg.style.display = "none";
      loading.style.display = "none";
      orderForm.style.display = "block";

      modalOverlay.style.display = "flex";
    });
  });

  modalClose.onclick = () => {
    modalOverlay.style.display = "none";
  };

  // نسخ كود التتبع عند الضغط عليه
  trackingCodeEl.onclick = () => {
    const range = document.createRange();
    range.selectNode(trackingCodeEl);
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
    document.execCommand('copy');
    alert('تم نسخ كود التتبع');
  };

  orderForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    // تحقق من المدخلات
    if(!orderForm.checkValidity()){
      errorMsg.textContent = "يرجى تعبئة جميع الحقول بشكل صحيح.";
      errorMsg.style.display = "block";
      return;
    }
    if(currentProduct.type === "code" && !codeTypeSelect.value){
      errorMsg.textContent = "يرجى اختيار نوع الكود.";
      errorMsg.style.display = "block";
      return;
    }
    if(transferImageInput.files.length === 0){
      errorMsg.textContent = "يرجى رفع صورة التحويل.";
      errorMsg.style.display = "block";
      return;
    }

    errorMsg.style.display = "none";
    orderForm.style.display = "none";
    loading.style.display = "block";
    buyBtn.disabled = true;

    // قراءة صورة التحويل كـ Base64
    const file = transferImageInput.files[0];
    const reader = new FileReader();

    reader.onload = async function() {
      const transferImageBase64 = reader.result;

      // تجهيز بيانات الطلب
      const dataToSend = {
        fullName: orderForm.fullName.value.trim(),
        province: orderForm.province.value.trim(),
        address: orderForm.address.value.trim(),
        phoneContact: orderForm.phoneContact.value.trim(),
        phoneTransfer: orderForm.phoneTransfer.value.trim(),
        productName: currentProduct.name,
        productPrice: currentProduct.price,
        codeType: codeTypeSelect.value,
        transferImageBase64
      };

      try {
        const response = await fetch(WEB_APP_URL, {
          method: "POST",
          body: JSON.stringify(dataToSend),
          headers: {"Content-Type": "application/json"}
        });
        const result = await response.json();

        if(result.status === "success"){
          successMsg.style.display = "block";
          orderDetails.innerHTML = `
            <p><strong>الاسم:</strong> ${result.data.fullName}</p>
            <p><strong>المحافظة:</strong> ${result.data.province}</p>
            <p><strong>العنوان:</strong> ${result.data.address}</p>
            <p><strong>رقم التواصل:</strong> ${result.data.phoneContact}</p>
            <p><strong>رقم المحول:</strong> ${result.data.phoneTransfer}</p>
          `;
          trackingCodeEl.textContent = result.data.trackingCode;

          loading.style.display = "none";
        } else {
          showError(result.message || "حدث خطأ أثناء الطلب");
          loading.style.display = "none";
          orderForm.style.display = "block";
          buyBtn.disabled = false;
        }

      } catch(err){
        showError("خطأ في الاتصال بالخادم، حاول مرة أخرى");
        loading.style.display = "none";
        orderForm.style.display = "block";
        buyBtn.disabled = false;
      }
    };

    reader.readAsDataURL(file);
  });

  function showError(msg){
    errorMsg.textContent = msg;
    errorMsg.style.display = "block";
  }
</script>

</body>
</html>
