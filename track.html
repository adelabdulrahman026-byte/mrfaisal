<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>طلب شراء</title>
  <!-- ... باقي الـ CSS كما هو ... -->
</head>
<body>
  <!-- ... باقي الـ HTML كما هو ... -->

  <script>
    const GS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzDY-wkAZx6eE539Zu1_hSyioIR03-4dyUPPN-glpGoZBTPFsFRMS0U-i-kPDhTFjs1pg/exec";

    const form = document.getElementById('orderForm');
    const message = document.getElementById('message');
    const loadingScreen = document.getElementById('loadingScreen');
    const confirmationScreen = document.getElementById('confirmationScreen');
    const orderDetailsDiv = document.getElementById('orderDetails');
    const trackingCodeDiv = document.getElementById('trackingCode');
    const closeBtn = document.getElementById('closeBtn');
    const buyBtn = document.getElementById('buyBtn');
    const mainContainer = document.getElementById('mainContainer');

    trackingCodeDiv.addEventListener('click', () => {
      const text = trackingCodeDiv.textContent;
      navigator.clipboard.writeText(text)
        .then(() => {
          trackingCodeDiv.textContent = "✅ تم النسخ! " + text;
          setTimeout(() => trackingCodeDiv.textContent = text, 2500);
        })
        .catch(() => {
          alert('فشل النسخ، يرجى نسخه يدوياً.');
        });
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();

      if (!form.checkValidity()) {
        message.style.color = "red";
        message.textContent = "يرجى تعبئة كل الحقول بشكل صحيح";
        return;
      }

      if (!form.transferImage.files.length) {
        message.style.color = "red";
        message.textContent = "يرجى رفع صورة التحويل";
        return;
      }

      message.style.color = "#218838";
      message.textContent = "";

      buyBtn.disabled = true;
      mainContainer.style.filter = "blur(3px)";
      loadingScreen.style.display = "flex";

      const reader = new FileReader();
      reader.onload = function(evt) {
        const dataURL = evt.target.result;

        const orderData = {
          name: form.name.value.trim(),
          phone: form.phone.value.trim(),
          governorate: form.governorate.value.trim(),
          phoneAlt: form.phoneAlt.value.trim(),
          address: form.address.value.trim(),
          price: 230,
          shipping: 30,
          transferNumber: form.transferNumber.value.trim(),
          transferImageBase64: dataURL
        };

        fetch(GS_WEBAPP_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(orderData)
        })
        .then(response => response.json())
        .then(response => {
          loadingScreen.style.display = "none";
          mainContainer.style.filter = "none";

          if (response.status === "success") {
            confirmationScreen.style.display = "flex";

            orderDetailsDiv.innerHTML =
              `<p><strong>الاسم:</strong> ${orderData.name}</p>
              <p><strong>رقم الهاتف:</strong> ${orderData.phone}</p>
              <p><strong>المحافظة:</strong> ${orderData.governorate}</p>
              <p><strong>الهاتف البديل:</strong> ${orderData.phoneAlt || '-'}</p>
              <p><strong>العنوان:</strong> ${orderData.address}</p>
              <p><strong>السعر + الشحن:</strong> ${orderData.price + orderData.shipping} جنيه</p>
              <p><strong>رقم التحويل:</strong> ${orderData.transferNumber}</p>
              <p><strong>نوع الطلب:</strong> مذكرة الصف الثالث الثانوي</p>
              <div class="checkmark-emoji" aria-hidden="true"></div>`;

            trackingCodeDiv.textContent = response.trackingCode;

            buyBtn.disabled = false;
            form.reset();
            message.textContent = "";
          } else {
            buyBtn.disabled = false;
            message.style.color = "red";
            message.textContent = response.message || "حدث خطأ أثناء الحفظ";
          }
        })
        .catch(error => {
          loadingScreen.style.display = "none";
          mainContainer.style.filter = "none";
          buyBtn.disabled = false;
          message.style.color = "red";
          message.textContent = "حدث خطأ في الاتصال بالخادم";
          console.error(error);
        });
      };

      reader.readAsDataURL(form.transferImage.files[0]);
    });

    closeBtn.addEventListener('click', () => {
      confirmationScreen.style.display = "none";
    });
  </script>
</body>
</html>
