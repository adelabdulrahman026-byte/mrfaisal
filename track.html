<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>شراء المنتج</title>
<style>
  body {
    font-family: 'Cairo', sans-serif;
    margin: 0;
    padding: 0;
    text-align: center;
  }
  video {
    max-width: 100%;
    height: auto;
    margin-bottom: 10px;
  }
  form {
    max-width: 500px;
    margin: auto;
    background: #f9f9f9;
    padding: 15px;
    border-radius: 10px;
  }
  input, select, button {
    width: 100%;
    padding: 8px;
    margin: 5px 0;
    font-size: 16px;
  }
  #successPopup {
    position: fixed;
    bottom: -100%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0px 0px 10px #aaa;
    transition: bottom 0.3s ease;
    width: 90%;
    max-width: 350px;
    text-align: center;
  }
  #successPopup.show {
    bottom: 20px;
  }
  .loading-msg {
    font-size: 18px;
  }
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
  }
</style>
</head>
<body>

<!-- أزرار اختيار المنتج -->
<button onclick="startOrder('third')">📘 مذكرة الصف الثالث الثانوي</button>
<button onclick="startOrder('second')">📙 مذكرة الصف الثاني الثانوي</button>
<button onclick="startOrder('akodna')">💻 أكوادنا</button>

<!-- الفيديوهات والملاحظات -->
<div id="video_third" style="display:none;">
  <video controls>
    <source src="https://files.catbox.moe/lgvvn8.mp4" type="video/mp4">
  </video>
</div>
<div id="note_third" style="display:none;">ملاحظات مذكرة الصف الثالث الثانوي</div>

<div id="video_second" style="display:none;">
  <video controls>
    <source src="https://files.catbox.moe/lgvvn8.mp4" type="video/mp4">
  </video>
</div>
<div id="note_second" style="display:none;">ملاحظات مذكرة الصف الثاني الثانوي</div>

<div id="video_akodna" style="display:none;">
  <video controls>
    <source src="https://files.catbox.moe/lgvvn8.mp4" type="video/mp4">
  </video>
</div>
<div id="note_akodna" style="display:none;">ملاحظات الأكواد</div>

<!-- نموذج الطلب -->
<form id="orderForm" style="display:none;">
  <input type="text" id="name" placeholder="الاسم" required>
  <input type="text" id="gov" placeholder="المحافظة" required>
  <input type="tel" id="phone1" placeholder="رقم الهاتف" required>
  <input type="text" id="address" placeholder="العنوان">
  <select id="codeType" style="display:none;">
    <option value="">اختر نوع الكود</option>
    <option value="كود 1">كود 1</option>
    <option value="كود 2">كود 2</option>
  </select>
  <input type="text" id="paymentNumber" placeholder="رقم التحويل عبر فودافون كاش" required>
  <input type="file" id="paymentProof" accept="image/*" required>
  <button type="button" onclick="submitOrder()">يلا اشتري</button>
</form>

<!-- البوب أب -->
<div id="successPopup">
  <div id="popupMessage"></div>
</div>

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxNhAfhsY_FRU9UsoK61HzMr_ATVn02xtmrb8hFEny06RlpmGxcdKYWXl5sQwyoOVoD/exec"
  const formData = {
    total: "230",
    orderType: ""
  };

  function hideAll() {
    ["third", "second", "akodna"].forEach(type => {
      document.getElementById("video_" + type).style.display = "none";
      document.getElementById("note_" + type).style.display = "none";
    });
    document.getElementById("orderForm").style.display = "none";
  }

  function startOrder(type) {
    hideAll();
    formData.orderType = {
      "third": "مذكرة الصف الثالث الثانوي",
      "second": "مذكرة الصف الثاني الثانوي",
      "akodna": "أكوادنا"
    }[type];

    document.getElementById("video_" + type).style.display = "block";
    document.getElementById("note_" + type).style.display = "block";
    document.getElementById("orderForm").style.display = "block";

    const codeSelect = document.getElementById("codeType");
    const addressField = document.getElementById("address");

    if (type === "akodna") {
      codeSelect.style.display = "block";
      codeSelect.required = true;
      addressField.style.display = "none";
      addressField.required = false;
    } else {
      codeSelect.style.display = "none";
      codeSelect.required = false;
      addressField.style.display = "block";
      addressField.required = true;
    }
  }

  function submitOrder() {
    const name = document.getElementById("name").value;
    const gov = document.getElementById("gov").value;
    const phone1 = document.getElementById("phone1").value;
    const address = document.getElementById("address").value;
    const paymentNumber = document.getElementById("paymentNumber").value;
    const codeType = document.getElementById("codeType").value;
    const file = document.getElementById("paymentProof").files[0];

    if (!paymentNumber || !file) return;

    const popup = document.getElementById("successPopup");
    const msg = document.getElementById("popupMessage");

    msg.innerHTML = `<div class="loading-msg">📦 جاري الشحن...<br><span style="display:inline-block; animation: bounce 1s infinite;">⏳</span></div>`;
    popup.classList.add("show");

    const reader = new FileReader();
    reader.onload = function (e) {
      const proofImage = e.target.result.split(",")[1];

      const payload = {
        ...formData,
        name,
        gov,
        phone1,
        address: formData.orderType === "أكوادنا" ? codeType : address,
        paymentNumber,
        proofImage
      };

      fetch(WEB_APP_URL, {
        method: "POST",
        body: JSON.stringify(payload),
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.json())
      .then(showPopup)
      .catch(() => showPopup({ success: false, error: "فشل في الإرسال" }));
    };
    reader.readAsDataURL(file);
  }

  function showPopup(res) {
    const popup = document.getElementById("successPopup");
    const msg = document.getElementById("popupMessage");

    if (res.success) {
      msg.innerHTML = `
        ✅ <strong>تم الشحن بنجاح</strong><br><br>
        كود التتبع: <strong>${res.trackingCode}</strong><br>
        الاسم: ${document.getElementById("name").value}<br>
        المحافظة: ${document.getElementById("gov").value}<br>
        الهاتف: ${document.getElementById("phone1").value}
      `;
    } else {
      msg.innerHTML = `❌ حصلت مشكلة: ${res.error || "حاول تاني"}`;
    }

    popup.classList.add("show");
  }
</script>
</body>
</html>
