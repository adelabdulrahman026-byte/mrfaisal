<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3 ثانوي تسليم الواجب - مستر فيصل</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet">
<style>
body{
  font-family:'Cairo',sans-serif;
  background:linear-gradient(to bottom,#fef9f3,#f1f0eb);
  margin:0;padding:0;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  min-height:100vh;
  user-select:none;
}
.container{
  width:95%;
  max-width:850px;
  margin-top:20px;
}
.card{
  background:#fff;
  border-radius:20px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:0 15px 40px rgba(0,0,0,0.12);
  animation:fadeIn 0.6s;
}
h2{
  text-align:center;
  color:#4a148c;
  margin-bottom:15px;
  font-size:24px;
}
input{
  width:100%;
  padding:14px;
  margin:10px 0;
  border-radius:12px;
  border:1px solid #ccc;
  font-size:16px;
  transition:0.3s;
}
input:focus{
  border-color:#4a148c;
  outline:none;
}
button{
  width:100%;
  padding:14px;
  margin:10px 0;
  background:#4a148c;
  color:#fff;
  border:none;
  border-radius:12px;
  font-size:17px;
  cursor:pointer;
  transition:0.3s;
  box-shadow:0 5px 15px rgba(0,0,0,0.1);
}
button:hover{
  background:#6a1b9a;
}
#onlineSubmit{
  background:#25D366;font-weight:bold;
}
#onlineSubmit:hover{
  background:#1ebe5d;
}
#centerSubmit{
  background:#4a148c;
}
#centerSubmit:hover{
  background:#6a1b9a;
}
.question-container{
  display:flex;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  min-height:500px;
}
.question-card{
  border:2px solid #d1c4e9;
  background:#f9f5ff;
  padding:20px;
  border-radius:15px;
  width:100%;
  max-width:700px;
  display:none;
}
.question-card.active{display:block;}
.options label{
  display:block;
  margin:8px 0;
  padding:10px;
  background:#ede7f6;
  border-radius:8px;
  cursor:pointer;
  transition:0.2s;
}
.options input{margin-left:10px;}
.options input:checked + span{
  background:#d1c4e9;
  transform:scale(1.05);
}
.nav-buttons{
  display:flex;
  justify-content:space-between;
  margin-top:15px;
}
#resultCard{display:none;}
#qrContainer{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  margin-top:15px;
  width:260px;
  height:260px;
  margin-left:auto;
  margin-right:auto;
}
#studentInfo{
  margin-top:10px;
  font-size:16px;
  text-align:center;
  white-space:pre-line;
}
.correct{color:green;font-weight:bold;}
.wrong{color:red;font-weight:bold;}
#gifStart,#gifLoading{
  display:none;
  width:300px;
  height:300px;
  margin:0 auto;
  text-align:center;
}
#gifMessage{
  text-align:center;
  font-weight:bold;
  color:#4a148c;
  margin-top:10px;
  font-size:18px;
}
.privacy-container{
  display:flex;
  align-items:center;
  margin:10px 0;
}
.privacy-container input[type=checkbox]{
  margin-left:10px;
  transform:scale(1.3);
  cursor:pointer;
}
.privacy-container a{
  color:#4a148c;
  font-weight:bold;
  text-decoration:none;
}
.exam-info {
  text-align: center;
  margin-top: 15px;
  padding: 10px;
  background-color: #f3e5f5;
  border-radius: 10px;
  font-weight: bold;
}
.exam-info p {
  margin: 5px 0;
  color: #4a148c;
}
.completed-message {
  text-align: center;
  padding: 20px;
  background-color: #e8f5e9;
  border-radius: 15px;
  margin: 20px 0;
  display: none;
}
.completed-message p {
  font-size: 18px;
  color: #2e7d32;
  font-weight: bold;
  margin-bottom: 15px;
}
.submit-button-container {
  display: none;
  margin-top: 20px;
}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
</style>
</head>
<body oncontextmenu="return false;">
<div class="container">

<!-- GIF البداية -->
<div id="gifStart">
<script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.6.2/dist/dotlottie-wc.js" type="module"></script>
<dotlottie-wc src="https://lottie.host/6c635af3-0ee0-46cc-9591-53d8df9c6044/7cuWsYrWj2.lottie" style="width:300px;height:300px;" speed="1" autoplay loop></dotlottie-wc>
<div id="gifMessage">يلا نختار نوع الطالب يا بطل 💪</div>
</div>

<!-- GIF تحميل الواجب -->
<div id="gifLoading">
<dotlottie-wc src="https://lottie.host/5829b1a2-22e2-4d58-ad28-3812b8290c8e/BXr2Nt8kFD.lottie" style="width:300px;height:300px;" speed="1" autoplay loop></dotlottie-wc>
<div id="gifMessage">يلا نعمل الواجب يا بطل 🚀</div>
</div>

<div class="card" id="startCard">
<h2>اختر نوع الطالب</h2>
<button onclick="selectType('online')">📱 اونلاين</button>
<button onclick="selectType('center')">🏫 سنتر</button>
</div>

<div class="card" id="formCard" style="display:none;">
<h2>املأ بياناتك</h2>
<input type="text" id="studentName" placeholder="الاسم">
<input type="text" id="studentMobile" placeholder="رقم الموبايل">
<input type="text" id="centerCode" placeholder="كود السنتر" style="display:none;">
<div class="privacy-container">
<input type="checkbox" id="privacyCheck">
<label for="privacyCheck">أوافق على <a href="https://www.mrfaisal.net/privacy.html" target="_blank">سياسة الخصوصية</a></label>
</div>
<button onclick="startHomework()">ابدأ الواجب</button>
</div>

<div class="card" id="homeworkCard" style="display:none;">
<h2>الواجب</h2>
<div class="question-container" id="homeworkForm"></div>
<div class="completed-message" id="completedMessage">
  <p>🎉 مبروك! خلصت كل الأسئلة</p>
  <p>دلوقتي تقدر تسلم واجبك اضغط علي سلم الواجب علشان تاخد qr بتاعك </p>
</div>
<div class="nav-buttons">
  <button id="prevQuestion" onclick="prevQuestion()">السؤال السابق</button>
  <button id="nextQuestion" onclick="nextQuestion()">التالي</button>
</div>
<div class="submit-button-container" id="submitButtonContainer">
  <button id="centerSubmit" style="display:none;" onclick="submitHomework()">سلم الواجب</button>
  <button id="onlineSubmit" style="display:none;" onclick="submitOnline()">سلم واجبك أونلاين</button>
</div>
</div>

<div class="card" id="resultCard">
<h2>تم التصحيح 🎉</h2>

<!-- QR -->
<div id="qrContainer"></div>

<!-- معلومات ميعاد الامتحان -->
<div class="exam-info">
  <p>📅 تاريخ ووقت تسليم الواجب:</p>
  <p id="submissionDate"></p>
  <p id="submissionTime"></p>
</div>

<p style="text-align:center;font-weight:bold;color:#4a148c;margin-top:10px;"> ده QR بتاعك خده اسكرين شوت ضروري علشان لو انت طالب سنتر مش هتدخل الحصه الا بيه ولو انت طالب اونلاين انزل اخر الصفحة وابعتلنا الاسكرين علي الواتس اب ملحوظة خد ال QR سكرين شوت📱</p>

<!-- تصحيح الأسئلة -->
<div id="answersReview"></div>

<!-- بيانات الطالب -->
<div id="studentInfo"></div>

<!-- نصيحة الطالب -->
<div id="advice" style="text-align:center;font-size:18px;margin-top:15px;color:#4a148c;font-weight:bold"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/kjua@0.1.1/dist/kjua.min.js"></script>
<script>
let homeworkData=[];
let studentType="";
let studentQR="";
let currentQuestion=0;
let isLastQuestionReached = false;

// دالة للحصول على التاريخ والوقت الحالي لمصر مع مراعاة التوقيت الصيفي
function getEgyptDateTime() {
  const now = new Date();
  
  // تحديد إزاحة التوقيت لمصر (توقيت شرق أوروبا EET)
  // مصر تستخدم توقيت شرق أوروبا (UTC+2) والتوقيت الصيفي (UTC+3)
  let egyptOffset = 2 * 60; // التوقيت الشتوي (UTC+2)
  
  // التحقق مما إذا كان التوقيت الصيفي ساريًا (عادة من آخر جمعة في أبريل إلى آخر خميس في أكتوبر)
  const year = now.getUTCFullYear();
  const apr = new Date(Date.UTC(year, 3, 30, 22)); // أبريل
  const oct = new Date(Date.UTC(year, 9, 30, 22)); // أكتوبر
  
  // العثور على آخر جمعة في أبريل
  while (apr.getUTCDay() !== 5) {
    apr.setUTCDate(apr.getUTCDate() - 1);
  }
  
  // العثور على آخر خميس في أكتوبر
  while (oct.getUTCDay() !== 4) {
    oct.setUTCDate(oct.getUTCDate() - 1);
  }
  
  // التحقق مما إذا كان الآن خلال فترة التوقيت الصيفي
  if (now >= apr && now < oct) {
    egyptOffset = 3 * 60; // التوقيت الصيفي (UTC+3)
  }
  
  const localOffset = now.getTimezoneOffset(); // إزاحة التوقيت المحلي بالدقائق
  const egyptTime = new Date(now.getTime() + (localOffset + egyptOffset) * 60000);
  
  // الأيام بالأسبوع بالعربية
  const days = ["الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة", "السبت"];
  
  // الأشهر بالعربية
  const months = [
    "يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو",
    "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"
  ];
  
  const dayName = days[egyptTime.getDay()];
  const day = egyptTime.getDate();
  const month = months[egyptTime.getMonth()];
  const yearEgypt = egyptTime.getFullYear();
  
  // تنسيق الوقت
  let hours = egyptTime.getHours();
  const minutes = egyptTime.getMinutes().toString().padStart(2, '0');
  const ampm = hours >= 12 ? 'مساءً' : 'صباحاً';
  hours = hours % 12;
  hours = hours ? hours : 12; // الساعة 0 تصبح 12
  
  return {
    date: `${dayName} ${day} ${month} ${yearEgypt}`,
    time: `الساعة ${hours}:${minutes} ${ampm}`,
    fullDateTime: `${dayName} ${day} ${month} ${yearEgypt} - ${hours}:${minutes} ${ampm}`
  };
}

function selectType(type){
  studentType = type;
  document.getElementById('startCard').style.display="none";
  document.getElementById('gifStart').style.display="block";
  setTimeout(()=>{
    document.getElementById('gifStart').style.display="none";
    document.getElementById('formCard').style.display="block";
    document.getElementById('centerCode').style.display = (type=="center")?"block":"none";
  },2000);
}

async function startHomework(){
  const name=document.getElementById('studentName').value.trim();
  const mobile=document.getElementById('studentMobile').value.trim();
  const privacyChecked=document.getElementById('privacyCheck').checked;

  if(name=="" || mobile=="") return alert("اكمل البيانات");
  if(!privacyChecked) return alert("يجب الموافقة على سياسة الخصوصية");

  document.getElementById('formCard').style.display="none";
  document.getElementById('gifLoading').style.display="block";

  try{
    const response = await fetch("https://script.google.com/macros/s/AKfycbxK4gKDWLc2wpVdTFzI4PjUIvQNCgXF7LEDmEYDTthTfqsExotEYfj2VvIF9a9t9naP/exec");
    homeworkData = await response.json();

    setTimeout(()=>{
      document.getElementById('gifLoading').style.display="none";
      const form=document.getElementById('homeworkForm');
      form.innerHTML="";
      homeworkData.forEach((q,i)=>{
        let div=document.createElement("div");
        div.className="question-card";
        div.innerHTML=`<p><b>${q.number}.</b> ${q.text}</p>`;
        let optsDiv=document.createElement("div");
        optsDiv.className="options";
        q.options.forEach(opt=>{
          optsDiv.innerHTML+=`<label><input type="radio" name="q${q.number}" value="${opt}"> <span>${opt}</span></label>`;
        });
        div.appendChild(optsDiv);
        form.appendChild(div);
      });
      document.getElementById('homeworkCard').style.display="block";
      showQuestion(0);
      updateNavigationButtons();
    },800);

  }catch(e){
    alert("❌ فشل تحميل الواجب");
    document.getElementById('formCard').style.display="block";
    document.getElementById('gifLoading').style.display="none";
  }
}

function showQuestion(index){
  const cards=document.querySelectorAll('.question-card');
  cards.forEach((c,i)=>c.classList.remove('active'));
  if(index>=0 && index<cards.length){
    cards[index].classList.add('active');
    currentQuestion=index;
    updateNavigationButtons();
  }
}

function updateNavigationButtons() {
  const isFirstQuestion = currentQuestion === 0;
  const isLastQuestion = currentQuestion === homeworkData.length - 1;
  
  document.getElementById('prevQuestion').style.display = isFirstQuestion ? 'none' : 'block';
  
  if (isLastQuestion && !isLastQuestionReached) {
    document.getElementById('nextQuestion').textContent = 'إنهاء الأسئلة';
  } else if (!isLastQuestion) {
    document.getElementById('nextQuestion').textContent = 'التالي';
  }
  
  // إظهار زر التسليم في آخر سؤال
  if (isLastQuestion) {
    document.getElementById('submitButtonContainer').style.display = 'block';
    if(studentType=="online") document.getElementById('onlineSubmit').style.display="block";
    if(studentType=="center") document.getElementById('centerSubmit').style.display="block";
  } else {
    document.getElementById('submitButtonContainer').style.display = 'none';
  }
  
  // إخفاء رسالة الإكمال إذا لم يكن هذا هو السؤال الأخير
  if (!isLastQuestion) {
    document.getElementById('completedMessage').style.display = 'none';
  }
}

function nextQuestion(){
  if(currentQuestion < homeworkData.length-1) {
    showQuestion(currentQuestion+1);
  } else if(currentQuestion === homeworkData.length-1 && !isLastQuestionReached) {
    // وصلنا إلى آخر سؤال
    isLastQuestionReached = true;
    document.getElementById('nextQuestion').style.display = 'none';
    document.getElementById('completedMessage').style.display = 'block';
  }
}

function prevQuestion(){
  if(currentQuestion>0) {
    isLastQuestionReached = false;
    document.getElementById('nextQuestion').style.display = 'block';
    document.getElementById('completedMessage').style.display = 'none';
    showQuestion(currentQuestion-1);
  }
}

function submitHomework(){ generateResult(false); }
function submitOnline(){ generateResult(true); }

function generateResult(isOnline){
  const name=document.getElementById('studentName').value;
  const mobile=document.getElementById('studentMobile').value;
  const code=document.getElementById('centerCode').value || "-";
  
  // الحصول على التاريخ والوقت الحالي لمصر
  const egyptDateTime = getEgyptDateTime();

  let score=0;
  let reviewHTML="";
  homeworkData.forEach(q=>{
    let sel=document.querySelector(`input[name="q${q.number}"]:checked`);
    let studentAnswer=sel?sel.value:"لم تجب";
    let correct=q.correct;
    let correctClass=(studentAnswer===correct)?"correct":"wrong";
    if(correctClass==="correct") score++;
    reviewHTML+=`<p><b>${q.number}.</b> ${q.text} <br>
      اختيارك: <span class="${correctClass}">${studentAnswer}</span> | 
      الإجابة الصحيحة: ${correct}</p>`;
  });

  // إضافة معلومات التاريخ والوقت إلى QR Code
  studentQR = `📚 واجب المحاضرة الرابعة\n✅ الطالب: ${name}\n📱: ${mobile}\n🏷 النوع: ${studentType}\n📊 الدرجة: ${score}/${homeworkData.length}\n📅 تاريخ التسليم: ${egyptDateTime.date}\n⏰ ${egyptDateTime.time}\n🔖 كود فريد: ${Math.random().toString(36).substring(2,10)}`;

  document.getElementById('homeworkCard').style.display="none";
  document.getElementById('resultCard').style.display="block";

  document.getElementById('qrContainer').innerHTML="";
  let qr = kjua({text:studentQR,size:250,render:'canvas',fill:'#4a148c',quiet:2,rounded:10});
  document.getElementById('qrContainer').appendChild(qr);

  // عرض معلومات التاريخ والوقت
  document.getElementById('submissionDate').innerText = egyptDateTime.date;
  document.getElementById('submissionTime').innerText = egyptDateTime.time;

  document.getElementById('answersReview').innerHTML = reviewHTML;
  document.getElementById('studentInfo').innerText = 
    `الاسم: ${name}\nالموبايل: ${mobile}\nالنوع: ${studentType}\nكود السنتر: ${code}\nدرجتك: ${score}/${homeworkData.length}\nوقت التسليم: ${egyptDateTime.fullDateTime}`;

  // نصيحة حسب الدرجة
  const adviceDiv = document.getElementById('advice');
  const total = homeworkData.length;
  if(score < total/2){
    adviceDiv.innerText = "😅 شد حيلك يا بطل! المرة الجاية هتكون أفضل 💪";
  } else if(score === total/2){
    adviceDiv.innerText = "🙂 كويس! بس ممكن تحسن شوي 👍";
  } else if(score > total/2){
    const phrases=["✨ أشطر شطور ✨","🐥 أشطر كتكوت 🐥","💯 ممتاز يا بطل 💯"];
    adviceDiv.innerText = phrases[Math.floor(Math.random()*phrases.length)];
  }

  if(isOnline){
    qr.toBlob(function(blob){
      const waUrl = `https://wa.me/201556618507?text=`;
      let file = new File([blob], "qr.png",{type:"image/png"});
      let reader = new FileReader();
      reader.onload = function(e){
        let imgData = e.target.result;
        let btn = document.createElement("a");
        btn.href = `https://api.whatsapp.com/send?phone=201556618507&text=الواجب&media=${encodeURIComponent(imgData)}`;
        btn.target="_blank";
        btn.id="waButton";
        btn.innerText="سلم واجبك أونلاين";
        btn.style.display="block";
        btn.style.width="100%";
        btn.style.textAlign="center";
        btn.style.padding="14px";
        btn.style.background="#25D366";
        btn.style.color="#fff";
        btn.style.marginTop="15px";
        btn.style.borderRadius="12px";
        btn.style.fontWeight="bold";
        btn.style.fontSize="16px";
        document.getElementById('resultCard').appendChild(btn);
      };
      reader.readAsDataURL(file);
    });
  }
}
</script>
</body>
</html>
